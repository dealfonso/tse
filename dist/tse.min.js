/* Copyright 2025 Carlos A. (https://github.com/dealfonso); License: https://opensource.org/license/mit/ */
(function(t){"use strict";if(typeof window==="undefined"){throw new Error("This script must be executed in a browser environment.")}const e="1.0.0";const o={};const n={attributePrefix:"data-bind-",templateDelimiter:/\${([^}]*)}/g,evalContext:window,observeMutations:true,debounceTime:10};let i={...n};let u=null;const r={textContent:Object.getOwnPropertyDescriptor(Node.prototype,"textContent"),innerHTML:Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML"),setAttribute:Element.prototype.setAttribute};function c(e,t){try{const n={...t||{},...o};const r=new Function("context",`with(context) { return ${e}; }`);return r(n)}catch(t){console.error(`Error evaluating expression "${e}":`,t);return`[Error: ${t.message}]`}}function s(t){if(typeof t!=="string"||!i.templateDelimiter.test(t))return t;i.templateDelimiter.lastIndex=0;return t.replace(i.templateDelimiter,(t,e)=>{const n=c(e);return n!==undefined?n:t})}function a(t){const e=t.nodeValue;if(!i.templateDelimiter.test(e))return;i.templateDelimiter.lastIndex=0;const n=e.replace(i.templateDelimiter,(t,e)=>{const n=c(e);return n!==undefined?n:t});if(n!==e){t.nodeValue=n}}function l(r){Array.from(r.attributes).forEach(t=>{if(t.name.startsWith(i.attributePrefix)){const e=t.name.substring(i.attributePrefix.length);const n=c(t.value);r[e]=n}})}function d(t=document.body){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,null,false);let n;while(n=e.nextNode()){if(n.nodeType===Node.TEXT_NODE){a(n)}else if(n.nodeType===Node.ELEMENT_NODE){l(n)}}}function f(){if(!window.MutationObserver)return null;if(u){u.disconnect();u=null}let e;const t=new MutationObserver(t=>{clearTimeout(e);e=setTimeout(()=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.TEXT_NODE){a(t)}else if(t.nodeType===Node.ELEMENT_NODE){l(t);d(t)}});if(t.type==="attributes"){l(t.target)}if(t.type==="characterData"){a(t.target)}})},i.debounceTime)});t.observe(document.body,{childList:true,attributes:true,characterData:true,subtree:true});u=t;return t}function p(){Object.defineProperty(Node.prototype,"textContent",{get:r.textContent.get,set:function(t){const e=s(t);return r.textContent.set.call(this,e)},configurable:true});Object.defineProperty(Element.prototype,"innerHTML",{get:r.innerHTML.get,set:function(t){const e=s(t);return r.innerHTML.set.call(this,e)},configurable:true});Element.prototype.setAttribute=function(t,e){if(typeof e==="string"){e=s(e)}return r.setAttribute.call(this,t,e)}}function m(){Object.defineProperty(Node.prototype,"textContent",r.textContent);Object.defineProperty(Element.prototype,"innerHTML",r.innerHTML);Element.prototype.setAttribute=r.setAttribute}window.DOMTemplateStringEvaluator={init:function(t={}){const e={...i};i={...i,...t};if(t.evalContext){Object.assign(o,t.evalContext)}const n=document.readyState!=="loading";const r=()=>{if(i.observeMutations){if(!u||e.debounceTime!==i.debounceTime||!e.observeMutations){f()}}else if(u){u.disconnect();u=null}};if(n){d();r()}else{document.addEventListener("DOMContentLoaded",()=>{d();r()})}p();return this},scan:function(t=document.body){d(t);return this},addToContext:function(t){Object.assign(o,t);return this},evaluate:function(t){return c(t,i.evalContext)},evaluateText:function(t){return s(t)},setContent:function(t,e,n="text"){const r=this.evaluateText(e);if(n==="html"){t.innerHTML=r}else{t.textContent=r}return this},getConfig:function(){return{...i}},getVersion:function(){return e},destroy:function(){if(u){u.disconnect();u=null}m()}};if(document.readyState!=="loading"){DOMTemplateStringEvaluator.init()}else{document.addEventListener("DOMContentLoaded",function(){DOMTemplateStringEvaluator.init()})}})(window);